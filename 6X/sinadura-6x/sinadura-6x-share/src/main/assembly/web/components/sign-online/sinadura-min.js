var sinadura=sinadura||[];sinadura.DefaultServerURL="http://localhost:8081/sinaduraCloud";function Sinadura(K,y){var N="sinadura";var I=2000;var H=600000;var R="rest/v1";var F="h";var B="s";var O="transactions";var D={tsAdd:"add",tsRemove:"remove",setConfig:"config/add",getDocuments:"documents/get",getStatus:"status/get",addDocument:"document/add"};var x={ERR_JS_SIGN_TIMEOUT:"ERR_JS_SIGN_TIMEOUT",ERR_WS_INTERNAL:"ERR_WS_INTERNAL"};var E={TS_STARTED:"TS_STARTED",CONFIG_READY:"CONFIG_READY",SIGN_STARTED:"SIGN_STARTED",SIGN_EXECUTED:"SIGN_EXECUTED",TS_ERROR:"TS_ERROR"};var G=K;var w=0;var A=G+"/"+R;var z=A+"/"+O;var M=function(c,a,b){console.log(c+" - "+a+" - "+b)};var L=y;var P={};var C=jQuery.Deferred();var J=jQuery.Deferred();var Q=[];if(!K){K=sinadura.DefaultServerURL}if(!window.console){console={log:function(){}}}startTransaction=function(a){jQuery.post(z+"/"+D.tsAdd,function(b){console.log("start transaction ok, uuid: "+b);L=b;a.resolve()}).fail(function(d,c,b){handleRestError(d,c,b)});return a.promise()};setConfig=function(a){config={properties:P};configString=JSON.stringify(config);console.log("set config: "+configString);jQuery.when.apply(this,Q).done(function(){jQuery.post(z+"/"+L+"/"+D.setConfig,{config:configString},function(b){console.log("set config ok: "+b);a.resolve()}).fail(function(d,c,b){handleRestError(d,c,b)})});return a.promise()};addDocumentRest=function(c,b,d,e,a){console.log("add document, id: "+b+" - name: "+e);jQuery.post(z+"/"+L+"/"+D.addDocument,{id:b,type:d,name:e,url:a},function(f){console.log("add document ok, id: "+f);c.resolve()}).fail(function(g,f,h){handleRestError(g,f,h)});return c.promise()};handleRestError=function(a,c,b){console.log("handleRestError xhr: "+JSON.stringify(a));console.log("handleRestError status: "+a.status);console.log("handleRestError textStatus: "+c);console.log("handleRestError errorThrown: "+b);if(a.status===500){M(a.responseJSON.code,a.responseJSON.message,a.status)}else{M(x.ERR_WS_INTERNAL,b,a.status)}};openApplication=function(){var a;if(A.indexOf("https")>-1){a=A.replace("https",N)+"/"+B+"/"+L}else{a=A.replace("http",N)+"/"+F+"/"+L}console.log("open application: "+a);var b=window.open(a,"_parent");b.blur();w=new Date()};pollSignStatus=function(a){setTimeout(function(){jQuery.ajax({type:"GET",url:z+"/"+L+"/"+D.getStatus,data:{},success:function(c){if(c==E.SIGN_EXECUTED){jQuery.get(z+"/"+L+"/"+D.getDocuments,function(f,e,d){console.log("get documents ok, code: "+d.status);if(d.status===200){console.log(f);a(f);J.resolve()}}).fail(function(d,f,e){handleRestError(d,f,e)})}else{if(c==E.TS_ERROR){jQuery.get(z+"/"+L+"/error/get",function(f,e,d){console.log("get error code ok, status: "+d.status);if(d.status===200){M(f.code,f.message,null)}}).fail(function(d,f,e){handleRestError(d,f,e)})}else{var b=new Date()-w;if(b<H){pollSignStatus(a)}else{console.log("pooling timeout");M(x.ERR_JS_SIGN_TIMEOUT,"sign timeout",null)}}}},error:function(d,c,b){handleRestError(d,c,b)},cache:false})},I)};this.removeTransaction=function(){jQuery.post(z+"/"+L+"/"+D.tsRemove,function(a){console.log("remove transaction ok");L=undefined}).fail(function(a,c,b){L=undefined;console.log("remove transaction xhr: "+JSON.stringify(a));console.log("remove transaction status: "+a.status);console.log("remove transaction textStatus: "+c);console.log("remove transaction errorThrown: "+b)})};this.setOption=function(b,a){P[b]=a};this.addDocument=function(c,d,a,b){jQuery.when(C).done(function(){var e=jQuery.Deferred();addDocumentRest(e,c,d,a,b);Q.push(e)})};this.setErrorCallback=function(a){M=a};this.sign=function(a){if(L===undefined){startTransaction(C)}else{C.resolve()}jQuery.when(C).done(function(){var b=jQuery.Deferred();setConfig(b);jQuery.when.apply(this,Q).done(function(){jQuery.when(b).done(function(){openApplication();pollSignStatus(a)})})})};this.getToken=function(){return L}};